---
title: "please insert your project title"
author: "please insert your name"
date: '`r format(Sys.Date(), "%Y-%m-%d")`'
output: html_document
abstract: Short project description.
knit: (function(inputFile, encoding) {
          rmarkdown::render(inputFile,
                            encoding = encoding, 
                            output_file = paste0(
                              xfun::sans_ext(inputFile), '_', Sys.Date(), '.html'),
                                output_dir = "../results/lab_book/")})
---

```{r setup, include=FALSE}
knitr::opts_knit$set(echo = TRUE,
                     root.dir = getwd(),
                     fig.width = 6, fig.height = 5,
                     warning = FALSE, 
                     message = FALSE)

result.dir <- paste0("results/",Sys.Date(),"/")

## creates result.dir with date in if not existent
ifelse(isFALSE(dir.exists(paste0("../",result.dir))), dir.create(paste0("../",result.dir),recursive = TRUE),"Result directory for today exists already!")
options(stringsAsFactors = FALSE) 
```

## Needed libraries
```{r libraries, message=FALSE}
library(mixOmics)
library(data.table)
library(kableExtra)
library(forcats)
library(tibble)
library(devtools)
library(dplyr)
library(tidyr)
library(plyr)
library(SummarizedExperiment)
library(grDevices)

```

## Load data
```{r message=FALSE, warning=FALSE}

# Read the transcript data
transcript_data <- data.table::fread("../data/machine_learning_dataset/fold_changes_correlation.csv") 

# Read the cytokine data
cytokine_data <- data.table::fread("../data/cytokine_luminex/220406_luminex_edited_data_FC.csv")

set.seed(5249) # for reproducibility, remove for normal use
```


## Take environment snapshot 
```{r}
#renv::snapshot()
```

## Metadata
```{r}

# Load sample metadata
sampleTable <- read.table("../data/metadata/sample_metadata_3.csv", 
                          sep = ",", header = TRUE) %>%
  dplyr::select(-c(age, sex))

# Load patient metadata
patient_metadata <- read.table("../data/metadata/patient_metadata.csv", 
                               sep = ",", header = TRUE)

# Join sample and patient metadata
sampleTable <- sampleTable %>% left_join(patient_metadata, by = "subject_ID")

# Change visits to dose and time point...
sampleTable <- sampleTable %>%
  mutate(
    dose = as.factor(plyr::mapvalues(visit,
      from = c(1, 2, 4, 5, 10, 11, 12),
      to   = c("0_dose1", "24_dose1", "0_dose2", "24_dose2", "0_dose3", "24_dose3", "48_dose3")
    )),
    group = as.factor(group)
  ) %>%
  # ...(sex) 0 and 1 to male and female...
  mutate(
    sex = as.factor(plyr::mapvalues(sex,
      from = c(0, 1),
      to   = c("male", "female")
    )),
    group = as.factor(sex)
  ) %>%
  # ...(prior covid) 0 and 1 to neg and pos
  mutate(
    prior_covid19 = as.factor(plyr::mapvalues(prior_covid19,
      from = c(0, 1),
      to   = c("neg", "pos")
    )),
    group = as.factor(prior_covid19)
  )

# Remove 24dose_2 from subject 21 (missing 0dose_2)
sampleTable <- subset(sampleTable, sample_ID != "P22761_1037_S37")

# Remove one sample from subject 7 (sample replicate)
sampleTable <- subset(sampleTable, sample_ID != "P26208_1060_S62")

# Remove individual that was not vaccinated in dose 3 and dose 2
sampleTable <- subset(sampleTable, sample_ID != "P27910_1044_S44")
sampleTable <- subset(sampleTable, sample_ID != "P27910_1031_S31")
sampleTable <- subset(sampleTable, sample_ID != "P27910_1037_S37")

# test which one to remove to evaluate effect of single samples
#sampleTable <- sampleTable %>% filter(group != "pos" | batch != "third" | visit != 4 & visit != 5)
#test <- sampleTable %>% filter(group == "pos", batch == "third", visit == 5 | visit == 4) 
sampleTable <- sampleTable %>% filter(batch != "third")

# Aligns transcript data & cytokine data by sample_ID

transcript_data <- arrange(transcript_data, sample_ID)
cytokine_data <- arrange(cytokine_data, subject_ID)

```

## Data Pre-processing
```{r}
trans_ds <- select(transcript_data, c(1, 3, 6:length(transcript_data))) #selects the sample_ID, group, and gene data 

cyto_ds <- select(cytokine_data, c(1, 3:35)) # Selects sample_ID, group, and cytokine data

#Resetting group values & names
cyto_ds[cyto_ds == "Experienced"] <- "pos"
cyto_ds[cyto_ds == "Naive"] <- "neg"
cyto_ds <- plyr::rename(cyto_ds, c("subject_ID" = "sample"))
cyto_ds <- plyr::rename(cyto_ds, c("Study group" = "group"))  
  
#Matches samples against against the transcript data
names_match <- trans_ds$sample_ID
cyto_ds <- cyto_ds %>%
  dplyr::filter(sample %in% names_match)

#Creates a list of exp/naive matching the sample
trans_groups <- as.data.frame(trans_ds$group)
trans_groups <- plyr::rename(trans_groups, c("trans_ds$group" = "group"))


#Doses 1-3
tds <- column_to_rownames(trans_ds, var = "sample_ID")
transcript_d1 <- select(tds, contains('_dose1'))
transcript_d2 <- select(tds, contains('_dose2'))
transcript_d3 <- select(tds, contains('_dose3'))

#Dose 1 cytokine data
time_d1 <- "V2"
cyto_d1 <- cyto_ds %>% dplyr::filter(Timepoint %in% time_d1)
#Dose 1 Cytokine correlation object 
cyto_d1 <- select(cyto_d1, c(4:34)) 

#Dose 2 cytokine data
time_d2 <- "V5"
cyto_d2 <- cyto_ds %>% dplyr::filter(Timepoint %in% time_d2)
#Cytokine correlation data dose
cyto_d2 <- select(cyto_d2, c(4:34)) 

#Dose #3 cytokine data
time_d3 <- "V11"
cyto_d3 <- cyto_ds %>% dplyr::filter(Timepoint %in% time_d3)
#Dose 3 Cytokine correlation object 
cyto_d3 <- select(cyto_d3, c(4:34))
```

## PCA
```{r}

pca.gene <- pca(transcript_d1, ncomp = 10, center = TRUE, scale = TRUE)
pca.cyto <- pca(cyto_d1, ncomp = 10, center = TRUE, scale = TRUE)

plot(pca.gene)
plot(pca.clinic)

```

## SessionInfo
```{r}
sessionInfo()
```


