---
title: "MOFA Transcriptomics & Secretomics?"
author: "Rodrigo & Matt"
date: '`r format(Sys.Date(), "%Y-%m-%d")`'
output: html_document
abstract: Short project description.
knit: (function(inputFile, encoding) {
          rmarkdown::render(inputFile,
                            encoding = encoding, 
                            output_file = paste0(
                              xfun::sans_ext(inputFile), '_', Sys.Date(), '.html'),
                                output_dir = "../results/lab_book/")})
---

```{r setup, include=FALSE}
knitr::opts_knit$set(echo = TRUE,
                     root.dir = getwd(),
                     fig.width = 6, fig.height = 5,
                     warning = FALSE, 
                     message = FALSE)

result.dir <- paste0("results/",Sys.Date(),"/")

## creates result.dir with date in if not existent
ifelse(isFALSE(dir.exists(paste0("../",result.dir))), dir.create(paste0("../",result.dir),recursive = TRUE),"Result directory for today exists already!")
options(stringsAsFactors = FALSE) 
```

## Needed libraries
```{r libraries, message=FALSE}
library(data.table)
library(MOFA2)
library(kableExtra)
library(forcats)
library(mgsub)
library(DESeq2)
library(pheatmap)
library(ggplot2)
library(ggrepel)
library(RColorBrewer)
library(limma)
library(gridExtra)
library(factoextra)
library(rafalib)
library(plotly)
library(tibble)
library(devtools)
library(ggprism)
library(biomaRt)
library(dplyr)
library(tidyr)
library(plyr)
library(basilisk)
library(SummarizedExperiment)
library(psych)
library(stringr)
library(corrplot)
library(grDevices)

```

## Load data
```{r message=FALSE, warning=FALSE}


# Read the transcript data
transcript_data <- data.table::fread("../data/machine_learning_dataset/TPM_fold_changes_correlation_psdc.csv") 

# Read the cytokine data
cytokine_data <- data.table::fread("../data/cytokine_luminex/220406_luminex_edited_data_FC.csv")

#DEG name list data objects
deg_list_d1 <- data.table::fread("../data/machine_learning_dataset/Dose 1 0-24 hours.csv") 
deg_list_d2 <- data.table::fread("../data/machine_learning_dataset/Dose 2 0-24 hours.csv") 
deg_list_d3 <- data.table::fread("../data/machine_learning_dataset/Dose 3 0-24 hours.csv")

deg_list_d1_p <- data.table::fread("../data/machine_learning_dataset/nonpadj/Dose 1 0-24 hours.csv") 
deg_list_d2_p <- data.table::fread("../data/machine_learning_dataset/nonpadj/Dose 2 0-24 hours.csv") 
deg_list_d3_p <- data.table::fread("../data/machine_learning_dataset/nonpadj/Dose 3 0-24 hours.csv")

deg_list_d1_exp <- data.table::fread("../data/machine_learning_dataset/Conv Dose 1 0-24 hours.csv")
deg_list_d2_exp <- data.table::fread("../data/machine_learning_dataset/Conv Dose 2 0-24 hours.csv")
deg_list_d3_exp <- data.table::fread("../data/machine_learning_dataset/Conv Dose 3 0-24 hours.csv")
deg_list_d1_nai <- data.table::fread("../data/machine_learning_dataset/Naïve Dose 1 0-24 hours.csv")
deg_list_d2_nai <- data.table::fread("../data/machine_learning_dataset/Naïve Dose 2 0-24 hours.csv")
deg_list_d3_nai <- data.table::fread("../data/machine_learning_dataset/Naïve Dose 3 0-24 hours.csv")

```


## Take environment snapshot 
```{r}
#renv::snapshot()
```

## Metadata
```{r}

# Load sample metadata
sampleTable <- read.table("../data/metadata/sample_metadata_3.csv", 
                          sep = ",", header = TRUE) %>%
  dplyr::select(-c(age, sex))

# Load patient metadata
patient_metadata <- read.table("../data/metadata/patient_metadata.csv", 
                               sep = ",", header = TRUE)

# Join sample and patient metadata
sampleTable <- sampleTable %>% left_join(patient_metadata, by = "subject_ID")

# Change visits to dose and time point...
sampleTable <- sampleTable %>%
  mutate(
    dose = as.factor(plyr::mapvalues(visit,
      from = c(1, 2, 4, 5, 10, 11, 12),
      to   = c("0_dose1", "24_dose1", "0_dose2", "24_dose2", "0_dose3", "24_dose3", "48_dose3")
    )),
    group = as.factor(group)
  ) %>%
  # ...(sex) 0 and 1 to male and female...
  mutate(
    sex = as.factor(plyr::mapvalues(sex,
      from = c(0, 1),
      to   = c("male", "female")
    )),
    group = as.factor(sex)
  ) %>%
  # ...(prior covid) 0 and 1 to neg and pos
  mutate(
    prior_covid19 = as.factor(plyr::mapvalues(prior_covid19,
      from = c(0, 1),
      to   = c("neg", "pos")
    )),
    group = as.factor(prior_covid19)
  )

# Remove 24dose_2 from subject 21 (missing 0dose_2)
sampleTable <- subset(sampleTable, sample_ID != "P22761_1037_S37")

# Remove one sample from subject 7 (sample replicate)
sampleTable <- subset(sampleTable, sample_ID != "P26208_1060_S62")

# Remove individual that was not vaccinated in dose 3 and dose 2
sampleTable <- subset(sampleTable, sample_ID != "P27910_1044_S44")
sampleTable <- subset(sampleTable, sample_ID != "P27910_1031_S31")
sampleTable <- subset(sampleTable, sample_ID != "P27910_1037_S37")

# test which one to remove to evaluate effect of single samples
#sampleTable <- sampleTable %>% filter(group != "pos" | batch != "third" | visit != 4 & visit != 5)
#test <- sampleTable %>% filter(group == "pos", batch == "third", visit == 5 | visit == 4) 
sampleTable <- sampleTable %>% filter(batch != "third")

# Aligns transcript data & cytokine data by sample_ID

transcript_data <- arrange(transcript_data, sample_ID)
cytokine_data <- arrange(cytokine_data, subject_ID)

```

### Principal Component Analysis (PCA)

Dimensionality reduction for evaluating outliers and global sample clusters for both quality control but also for primary exploratory analysis.

```{r}
# PCA plot on mRNA data

#preparing the data 
tds <- select(transcript_data, c(1, 3, 6:length(transcript_data))) #selects the sample_ID, group, and gene data 

tds <- select(tds, c(1:18506))
trans_groups <- as.data.frame(tds$group)
trans_groups <- plyr::rename(trans_groups, c("tds$group" = "group"))



pca_ds <- tds # creating a second object for transcript data analysis -> adjusted
pca_ds <- column_to_rownames(pca_ds, var = "sample_ID")
pca_ds <- select(pca_ds, contains('_dose1'))


#creating PCA results object
pcaRes <- prcomp(t(pca_ds)) #as table, returns PCA 
pcaRes_genesort <- prcomp(pca_ds) #necessary for returning genes sorted by PCA

varExp <- round(summary(pcaRes)[[1]], digits = 2)

# Scree plot, showing contribution of principal components in descending order
pca.var <- pcaRes$sdev^2
pca.var.per <- round(pca.var / sum(pca.var) * 100, 1)

barplot(pca.var.per, main = "Scree Plot", 
        xlab = "Principal Component", 
        ylab = "Percent Variation")

# Explore which variables contribute the most for each PC
var <- get_pca_var(pcaRes)
var$contrib %>%
  as.data.frame() %>%
  arrange(desc(Dim.1)) %>%
  head() %>%
  kableExtra::kable() %>%
  kable_styling(bootstrap_options = "striped", full_width = FALSE)

```

## PCA plots and visualisations. 
```{r}
#visualisations 
fviz_pca_ind(pcaRes,
             col.ind = "cos2", # Color by the quality of representation
             gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
             repel = TRUE     # Avoid text overlapping
             )

fviz_pca_biplot(pcaRes, select.ind = list(contrib = 10), 
               select.var = list(contrib = 10),
               ggtheme = theme_minimal())
```

## Extraction of main contributing variables for use in MOFA. 

```{r}
# Results for individuals
res.ind <- get_pca_ind(pcaRes_genesort)
res.ind$coord          # Coordinates
res.ind$contrib        # Contributions to the PCs
res.ind$cos2           # Quality of representation

# Extract loadings and eigenvalues
loadings <- pcaRes_genesort$rotation  # Loadings (variable loadings on PCs)
eigenvalues <- pcaRes_genesort$sdev^2  # Eigenvalues (variance explained by each PC)


# Calculate variable contributions to PC1
contributions_to_PC1 <- (loadings[, 1]^2) * eigenvalues[1]

# Sort variables by contribution to PC1 in descending order
sorted_variables <- names(contributions_to_PC1)[order(-contributions_to_PC1)]

# Select the top N variables contributing to PC1 (e.g., top 10)
top_N <- 1000
top_variables_PC1 <- sorted_variables[1:top_N]

#print(top_variables_PC1)


# Calculate variable contributions to PC2
contributions_to_PC2 <- (loadings[, 2]^2) * eigenvalues[2]

# Sort variables by contribution to PC2 in descending order
sorted_variables <- names(contributions_to_PC2)[order(-contributions_to_PC2)]

# Select the top N variables contributing to PC2 (e.g., top 10)
top_N <- 1000
top_variables_PC2 <- sorted_variables[1:top_N]

#print(top_variables_PC2)


#For loop for extracting the top N variables contributing to each PC
n=0
pca_list <- NULL
pca_row <- NULL
for (i in colnames(loadings)) {
  n <- n+1   
  contributions_to_PC <- (loadings[, n]^2) * eigenvalues[n]

# Sort variables by contribution to PC1 in descending order
sorted_variables <- names(contributions_to_PC)[order(-contributions_to_PC)]

# Select the top N variables contributing to PC1 (e.g., top 10)
top_variables_PC <- sorted_variables[1:top_N]

  print(i)
  pc_table <- as.data.table(top_variables_PC)
  print(top_variables_PC)
  pca_list <- cbind(pca_list, pc_table)
  pca_row <- bind_rows(pca_row, pc_table)
  }

#
counts_pca_row <- count(pca_row)
pcas_row <- column_to_rownames(counts_pca_row, var = "top_variables_PC")


##
hist(as.matrix(pca_ds)) 

#filtering by fold change over 0.5 
#pca_ds_filtered <- pca_ds[sapply(pca_ds, function(x) x > 0.5)]

```

## Filtering the fold change data by variance

Using the PCA results, the data set is filtered to select the top 10% of genes that are responsible for the variance. This 10% is used in the following Multi Omics Factor Analysis

```{r}

var_pca_ds <- as.data.frame.data.frame(tds)
names <- var_pca_ds$sample_ID
var_pca_ds <- column_to_rownames(var_pca_ds, var = "sample_ID")
var_pca_ds <- dplyr::select(var_pca_ds, contains('_dose1'))

# Calculate the variance for each column
variance_values <- apply(var_pca_ds, 2, var, na.rm = TRUE)

# Determine the number of columns to select (top 10%)
percentage_to_select <- 0.1
num_columns_to_select <- round(percentage_to_select * ncol(var_pca_ds))

# Sort columns by variance in descending order and select the top columns
selected_columns <- names(sort(variance_values, decreasing = TRUE)[1:num_columns_to_select])

# Subset the data frame to retain only the selected columns
pca_ds_filtered <- var_pca_ds[, selected_columns, drop = FALSE]

# Print the filtered data frame
#print(pca_ds_filtered)

#filtering with Spearman correlation after variance
#spear_genes <- pca_ds_filtered %>% select(1:900)

pca_ds_filtered$sample_ID <- names #this might need to be changed


```


# MOFA Data formatting

```{r}

#Preparation for the MOFA data table. Converting genes to unique row with fold change while preserving sample & group 

#adding back the groups
pca_ds_filtered <- cbind(pca_ds_filtered, group = trans_groups) 

trans_dt <- pivot_longer(pca_ds_filtered,
    cols = !sample_ID:group,                      
    names_to = "feature",
    values_to = "value",
  )

trans_dt <- plyr::rename(trans_dt, c("sample_ID" = "sample")) 
trans_dtv <- cbind(trans_dt, view = "mRNA" )

#cytokine data processing, choosing sample with timepoint
time_d1 <- "V2"
cyto_x <- cytokine_data %>% dplyr::filter(Timepoint %in% time_d1)
cyto_t <- select(cyto_x, c(1, 4:35)) #takes the subject ID and the cytokines, add '4' to include group

cyto_hist <- select(cyto_x, c(5:35))
hist(as.matrix(cyto_hist))

#Resetting group values & names
cyto_t[cyto_t == "Experienced"] <- "pos"
cyto_t[cyto_t == "Naive"] <- "neg"
cyto_t <- plyr::rename(cyto_t, c("subject_ID" = "sample"))
cyto_t <- plyr::rename(cyto_t, c("Study group" = "group"))


#Matches samples against against the transcript data
names_match <- tds$sample_ID
cyto_t <- cyto_t %>%
  dplyr::filter(sample %in% names_match)


#Preparing for the MOFA data table converting cytokine to unique row with fold change while preserving sample names
cyto_dt <- pivot_longer(cyto_t,
    cols = !sample:group,
    names_to = "feature",
    values_to = "value",
  )

#adding new view column
cyto_dtv <- cbind(cyto_dt, view = "cytokine" )

#moving group to match transcript data
cyto_dtv <- relocate(cyto_dtv, group, .after = sample)


#creates data table object for MOFA from both data sets 
dt <- bind_rows(trans_dtv, cyto_dtv)

```

## MOFA integration
```{r}
# MOFA

class(dt)
dt <- as.data.table(dt)

dt[,group:=NULL] #necessary once groups are added to the dt object


MOFAobject <- create_mofa(dt)

print(MOFAobject)

plot_data_overview(MOFAobject)

data_opts <- get_default_data_options(MOFAobject)
#head(data_opts)

data_opts$scale_views = TRUE 

model_opts <- get_default_model_options(MOFAobject)
#head(model_opts)

model_opts$num_factors = 5
model_opts$spikeslab_weights = TRUE

train_opts <- get_default_training_options(MOFAobject)
#head(train_opts)

train_opts$seed = 123
train_opts$verbose = TRUE

MOFAobject <- prepare_mofa(
  object = MOFAobject,
  data_options = data_opts,
  model_options = model_opts,
  training_options = train_opts
)

outfile = file.path(paste0("../",result.dir,"model.hdf5"))
MOFAobject.trained <- run_mofa(MOFAobject, outfile, use_basilisk = TRUE)


head(MOFAobject.trained@cache$variance_explained$r2_total[[1]]) # group 1

plot_variance_explained(MOFAobject.trained, x="view", y="factor")

model <- MOFAobject.trained
```

##Downstream analysis via MOFA
Currently commented out due to knit function breaking on model <- MOFAobject.trained not being recognized or found
```{r}
 
 #Knit function doesn't recognize model as acquiring MOFAobject.trained data or MOFAobject.trained commented out for knit
model <- MOFAobject.trained


plot_variance_explained(model, x="group", y="factor", plot_total = T)[[2]]
plot_factors(model,
  factor = 1:3,
  color_by = "group",
)

plot_weights(model,
  view = "cytokine",
  factor = 1,
  nfeatures = 10,     # Number of features to highlight
  scale = T,          # Scale weights from -1 to 1
  abs = F             # Take the absolute value?
)

plot_data_heatmap(model,
  view = "cytokine",         # view of interest
  factor = 1,             # factor of interest
  features = 20,          # number of features to plot (they are selected by weight)

  # extra arguments that are passed to the `pheatmap` function
  cluster_rows = TRUE, cluster_cols = FALSE,
  show_rownames = TRUE, show_colnames = FALSE
)

plot_weights(model,
  view = "mRNA",
  factor = 1,
  nfeatures = 10,     # Number of features to highlight
  scale = T,          # Scale weights from -1 to 1
  abs = F             # Take the absolute value?
)

plot_weights(model,
  view = "mRNA",
  factor = 2,
  nfeatures = 10,     # Number of features to highlight
  scale = T,          # Scale weights from -1 to 1
  abs = F             # Take the absolute value?
)


plot_data_heatmap(model,
  view = "mRNA",         # view of interest
  factor = 1,             # factor of interest
  features = 20,          # number of features to plot (they are selected by weight)

  # extra arguments that are passed to the `pheatmap` function
  cluster_rows = F, cluster_cols = TRUE,
  show_rownames = TRUE, show_colnames = TRUE
)

plot_data_heatmap(model,
  view = "mRNA",         # view of interest
  factor = 2,             # factor of interest
  features = 20,          # number of features to plot (they are selected by weight)

  # extra arguments that are passed to the `pheatmap` function
  cluster_rows = F, cluster_cols = TRUE,
  show_rownames = TRUE, show_colnames = TRUE
)

plot_top_weights(model,
  view = "mRNA",
  factor = 1,
  nfeatures = 10
)

plot_top_weights(model,
  view = "mRNA",
  factor = 2,
  nfeatures = 10
)


plot_top_weights(model,
  view = "cytokine",
  factor = 1,
  nfeatures = 10
)

# #scatter plot using MOFA model
plot_data_scatter(model,
  view = "mRNA",         # view of interest
  factor = 1,             # factor of interest
  features = 10,           # number of features to plot (they are selected by weight)
  add_lm = TRUE,          # add linear regression
  color_by = "MCP-2"
)

```

### Downstream analysis using MOFA weights: mRNA transcripts & Cytokines

Top weighted genes and cytokines identified for data visualization of MOFA Factor 1.  

```{r}
mRNA_weights <- get_weights(model, views = "mRNA", factors = "Factor1", as.data.frame = T)
head(mRNA_weights, n=10)

# Sort values by factor contribution in descending order
sorted_weights_mRNA <- mRNA_weights[order(-mRNA_weights$value),]
print(sorted_weights_mRNA)

# Select the top N variables contributing to factor 1
top_x <- 10
top_weights_mRNA <- sorted_weights_mRNA[1:top_x,]

cyto_weights <- get_weights(model, views = "cytokine", factors = "Factor1", as.data.frame = T)
head(cyto_weights, n=10)

# Sort values by factor contribution in descending order
sorted_weights_cyto <- cyto_weights[order(-cyto_weights$value),]

# Select the top N variables contributing to factor 1 
top_x2 <- 2
top_weights_cyto <- sorted_weights_cyto[1:top_x2,]


#Matches sorted weights against the transcript data in MOFA format
weighted_genes <- top_weights_mRNA$feature
weighted_fc <- trans_dtv %>%
  dplyr::filter(feature %in% weighted_genes)

#Matches sorted weights against the transcript data in MOFA format
cyto_factor <- top_weights_cyto$feature
weighted_cyto <- cyto_dtv %>%
  dplyr::filter(feature %in% cyto_factor)
```

# Data preparation for plotting top weighted cytokines against transcripts :: removed due to MAP3K no longer part of top weights in Factor 1, updated RPKM data set

```{r}

#MCP-2 only
# cyt_a <- "MCP-2"
# MCP_2_weighted <- weighted_cyto %>%
#   dplyr::filter(feature %in% cyt_a)
#   
# #IP-10 only
# cyt_b <- "IP-10"
# IP_10_weighted <- weighted_cyto %>%
#   dplyr::filter(feature %in% cyt_b)
# 
# #Map3k
# gene_a <- "MAP3K11_dose1"
# MAP3K_weighted <- weighted_fc %>%
#   dplyr::filter(feature %in% gene_a)
# 
# 
# #sorting by sample map3k
# plot_map3k_raw <- arrange(MAP3K_weighted, sample)
# 
# #MCP-2
# plot_MCP_raw <- arrange(MCP_2_weighted, sample)
# plot_MCP_raw <- plyr::rename(plot_MCP_raw, c("value" = "MCP_2"))
# raw_mcp <- plot_MCP_raw %>% select("MCP_2")
# 
# plot_rawfc_dt <- cbind(plot_map3k_raw, raw_mcp)
# 
# 
# #ip10
# plot_ip_raw <- arrange(IP_10_weighted, sample)
# plot_ip_raw <- plyr::rename(plot_ip_raw, c("value" = "IP_10"))
# raw_ip <- plot_ip_raw %>% select("IP_10")
# 
# plot_rawfcx_dt <- cbind(plot_map3k_raw, raw_ip)
# 
# #protein raw fold change for IP-10 & MCP-2
# protein_raw <- cbind(raw_ip, raw_mcp)
# 
# 
# #data selection for plot generation for loops
# raw_genes <-  tds %>%
#   select(sample_ID, group, weighted_genes)
#  raw_genes <- plyr::rename(raw_genes, c("sample_ID" = "sample"))
# raw_genes <- arrange(raw_genes, sample)
# 
# raw_plot <- cbind(raw_genes, protein_raw)
# 
# raw_plot <- as.data.frame(raw_plot)
# 
# # for loops for generating plots MCP-2
# for (i in colnames(raw_plot[3:12])) {
#  
#    m <- ggplot(raw_plot, aes(x = raw_plot[ , i] , y = MCP_2, color = group, shape = i )) +
#     geom_point()  + geom_smooth(method=lm, se = F, color="black") 
# 
#   print(m) 
# }
# 
# # for loops for generating plots IP-10
# for (i in colnames(raw_plot[3:12])) {
# 
#     m <- ggplot(raw_plot, aes(x = raw_plot[ , i] , y = IP_10, color = group, shape = i )) +
#     geom_point()  + geom_smooth(method=lm, se = F, color="black") + ggpubr::stat_cor(method = "spearman")
# 
#   print(m) 
# }
# 


```

##Scaling data sets: removed due to updated RPKM data set

```{r}
#Scaling functions for scaling on both data sets
# scale_standard <- function(x){(x-min(x))/(max(x)-min(x))} #scaling 0 to 1
# scale_normal <- function(x){2* ((x - min(x))/(max(x)-min(x))) -1} #scaling -1 to 1
# 
# #Both cytokines
# cyto_scaled_v <- scale_standard(weighted_cyto$value) 
# cyto_scaled <- weighted_cyto
# cyto_scaled$value <- cyto_scaled_v  
# 
# #MCP-2 scaled
# MCP_scaled_v <- scale_standard(MCP_2_weighted$value) 
# MCP_scaled <- MCP_2_weighted
# MCP_scaled$value <- MCP_scaled_v  
# 
# #IP-10 scaled
# IP_scaled_v <- scale_standard(IP_10_weighted$value) 
# IP_scaled <- IP_10_weighted
# IP_scaled$value <- IP_scaled_v
# 
# 
# 
# #mRNA scaled
# mRNA_scaled_v <- scale_normal(weighted_fc$value) 
# mRNA_scaled <- weighted_fc
# mRNA_scaled$value <- mRNA_scaled_v
# 
# 
# #Duplication for insertion in mRNA FC data table 
# MCP_scaled <- plyr::rename(MCP_scaled, c("value" = "MCP_2"))
# MCP_scaled_dup <- MCP_scaled %>% slice(rep(1:n(), each = 10))
# 
# #sorting by sample
# plot_mRNA_scaled <- arrange( mRNA_scaled, sample)
# plot_MCP_scaled_dup <- arrange(MCP_scaled_dup, sample)
# 
# 
# new_mcp <- plot_MCP_scaled_dup %>% select("MCP_2")
# 
# plot_fc_dt <- cbind(plot_mRNA_scaled, new_mcp)
# 
 

#fc_dt <- bind_rows(mRNA_scaled, cyto_scaled)
```

## Scatter plots: removed due to updated RPKM data set
```{r}
# ggplot(plot_fc_dt, aes(x = value, y = MCP_2, color = group, shape = feature)) +
#   geom_point()  
#From data in MOFA data format
# ggplot(plot_rawfc_dt, aes(x = value, y = MCP_2, color = group, shape = feature)) +
#   geom_point()  + geom_smooth(method=lm, se = F, color="black")
# 
# ggplot(plot_rawfcx_dt, aes(x = value, y = IP_10, color = group, shape = feature)) +
#   geom_point()  + geom_smooth(method=lm, se = F, color="black")



```
## Factor values correlated with spike W6
Already known correlation with higher avidity and previous infection

```{r}
#Retrieves factor associated value and merges with meta data
factor1 <- get_factors(model, factors = c("Factor1"), scale = F, as.data.frame = T) %>% 
  inner_join(model@samples_metadata %>% select(-group), by="sample")

#Binds the MOFA Factor1 dataset with spike avidity data week 6
factor1_spike <- cbind(factor1[,1:3], transcript_data[,3:4])

#Scatter plot
plotfactor1 <- ggplot(factor1_spike, aes(x = value, y = Spike_W6, color = group)) +
  geom_point()  + geom_smooth(method=lm, se = F, color="black")

plotfactor1 + scale_y_continuous(trans = 'log2') + ggpubr::stat_cor(method = "spearman")

#sampleDist <- cor(vst_matrix, method = "spearman")

# fold_changes_ab_data_dt %>%
#   select_if(colnames(.) %in% c("group","subject_ID","Spike_Avidity_W6",p_correlations$genes)) %>%
#   tidyr::pivot_longer(cols =  c(colnames(.), -"group",-"subject_ID",-"Spike_Avidity_W6" ), values_to = "FC_log2", names_to = "genes") %>% 
# ggplot(aes(x = FC_log2, y = Spike_Avidity_W6)) +
#   geom_point(aes(color = group)) +
#   geom_smooth(method = "glm") +
#   ggpubr::stat_cor(method = "spearman")+
#   scale_y_log10() +
#   theme_bw() +
#   facet_wrap(~genes, ncol = 4)

#Saves plot
ggsave(paste0("../",result.dir,"Factor1_vs_spike.pdf"), plotfactor1, width = 5, height = 5)
```

## Spearman correlations between MCP-2, IP-10 & assorted genes: removed due to updated RPKM data set 
```{r}

#Selects FC raw from data plot object MAP3K/MCP-2
# spear_map <- plot_rawfc_dt %>% select(value,"MCP_2")
# 
# #Correlations test between MAP3K & MCP-2 data
# spearman_map <- corr.test(spear_map, method="spearman", adjust="none")
# spearman_map$p #i.e. highly correlated only within each data set
# 
# #Correlations test between raw transcript (after variance sort) FC & protein FC (IP-10 & MCP-2)
# spearman_raw <- corr.test(spear_genes, protein_raw, method ="spearman", adjust ="fdr")
# #Generates list of p-values for each gene correlated with the proteins
# sigs <- spearman_raw$p
# #list of logical values 
# sig_list <- spearman_raw$p < 0.05 
# 
# sig_list_df <- as.data.frame(sig_list)
# 
# 
# # Finds row indices where either column is TRUE
# row_indices <- which(sig_list[,1] | sig_list[,2])
# 
# # Extracts row names based on the row indices
# row_names_spear <- rownames(sig_list_df[row_indices, ])
# 
# #object with the filtered genes via correlation
# spear_genes_filtered <- spear_genes %>% select(row_names_spear)
# 
# 
# #Sorting for a smaller pool of genes p < 0.01
# sigs_one <- spearman_raw$p
# sig_list_one <- spearman_raw$p < 0.01
# sig_list_one_df <- as.data.frame(sig_list_one)
# 
# row_indices_slo <- which(sig_list_one[,1] | sig_list_one[,2])
# 
# # Extracts row names based on the row indices
# row_names_spear_one <- rownames(sig_list_one_df[row_indices_slo, ])
# 
# #object with the filtered genes via correlation
# spear_genes_filtered_one <- spear_genes %>% select(row_names_spear_one)
# 
# #adding back in the groups, large plot spear_genes_filtered_one
# fc_groups <- tds %>% select((c("sample_ID","group")))
# fc_groups <- plyr::rename(fc_groups, c("sample_ID" = "sample"))
# fc_groups_sort <- arrange(fc_groups, sample)
# 
# sgfo <- rownames_to_column(spear_genes_filtered_one)
# sgfo_fc <- plyr::rename(sgfo, c("rowname" = "sample"))
# plot_sgfo_raw <- arrange(sgfo_fc, sample)
# plot_sgfo_raw <- cbind(plot_sgfo_raw, group = fc_groups_sort$group, raw_mcp, raw_ip)
# 
# #Plotting ... 
# #For loop for printing plots by gene 
# 
# #p < 0.01
# for (i in colnames(plot_sgfo_raw[2:12])) {
# print(i)
# m <- ggplot(plot_sgfo_raw, aes(x = plot_sgfo_raw[ , i] , y = MCP_2, color = group, shape = i )) +
#   geom_point()  + geom_smooth(method=lm, se = F, color="black")
# 
# # + facet_wrap( ~ MCP_2)
# #print(i)
# #print(plot_sgfo_raw[ , i])
# #print(plot_sgfo_raw[ , 14])
# print(m) 
# }
# 
# #p < 0.05
# sgffive <- rownames_to_column(spear_genes_filtered)
# sgff_fc <- plyr::rename(sgffive, c("rowname" = "sample"))
# plot_sgff_raw <- arrange(sgff_fc, sample)
# plot_sgff_raw <- cbind(plot_sgff_raw, group = fc_groups_sort$group, raw_mcp, raw_ip)
# 
# #heatmaps needed instead of individual correlations. 
# # for loops for generating plots p < 0.05
# for (i in colnames(plot_sgff_raw[2:72])) {
#   m <- ggplot(plot_sgff_raw, aes(x = plot_sgff_raw[ , i] , y = MCP_2, color = group, shape = i )) +
#     geom_point()  + geom_smooth(method=lm, se = F, color="black")
# # + facet_wrap( ~ MCP_2)
# #print(i)
# #print(plot_sgfo_raw[ , i])
# #print(plot_sgfo_raw[ , 14])
#   print(m) 
# }
# 
# for (i in colnames(plot_sgff_raw[2:72])) {
#   m <- ggplot(plot_sgff_raw, aes(x = plot_sgff_raw[ , i] , y = IP_10, color = group, shape = i )) +
#     geom_point()  + geom_smooth(method=lm, se = F, color="black")
# # + facet_wrap( ~ MCP_2)
# #print(i)
# #print(plot_sgfo_raw[ , i])
# #print(plot_sgfo_raw[ , 14])
#   print(m) 
# }
# 
# 
# #The following were done by hand
# #ensg
# ensg_fc <- ads_filtered %>% select("ENSG00000284770_dose1", group)
# ensg_fc <- arrange(ensg_fc, rownames(ensg_fc))
# plot_spearman_1 <- cbind(ensg_fc, raw_mcp)
# plot_spearman_2 <- cbind(ensg_fc, raw_ip)
# 
# #HLA-DQA2
# hladq_fc <- ads_filtered %>% select("HLA-DQA2_dose1", group)
# hladq_fc <- plyr::rename(hladq_fc, c("HLA-DQA2_dose1" = "HLA_DQA2_dose1"))
# hladq_fc <- arrange(hladq_fc, rownames(hladq_fc))
# 
# #AEBP1
# aebp1_fc <- ads_filtered %>% select("AEBP1_dose1", group)
# aebp1_fc <- arrange(aebp1_fc, rownames(aebp1_fc))
# plot_spearman_1 <- cbind(aebp1_fc, raw_mcp)
# plot_spearman_2 <- cbind(aebp1_fc, raw_ip)


#general objects needing manual changes to run the below plots
# ggplot(plot_spearman_1, aes(x = ENSG00000284770_dose1, y = MCP_2, color = group, )) +
#   geom_point()  + geom_smooth(method=lm, se = F, color="black")
# 
# ggplot(plot_spearman_2, aes(x = AEBP1_dose1, y = IP_10, color = group, )) +
#   geom_point()  + geom_smooth(method=lm, se = F, color="black")





```


##

```{r}

#New chunk


```

##MOFA functions 

```{r}
cds <- transcript_data

#data formatting
#this function uses an object that has manually filtered for sample_ID, group, and the genes
format_mofa <- function(x) {
  
  dt_long <- pivot_longer(x ,
    cols = !sample_ID:group,                      
    names_to = "feature",
    values_to = "value",
  )

  dt_long <- plyr::rename(dt_long, c("sample_ID" = "sample")) 
  dtv <- cbind(dt_long, view = "mRNA" )
  x <- dtv
}

ded <- format_mofa(tds)


#}
```


## SessionInfo
```{r}

sessionInfo()
```


